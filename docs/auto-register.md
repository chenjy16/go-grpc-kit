# gRPC 服务自动注册功能

## 概述

go-grpc-kit 框架支持通过配置指定目录来实现 gRPC 服务的自动注册功能。该功能可以自动扫描指定目录中的 Go 文件，识别 gRPC 服务实现，并生成相应的注册代码。

## 功能特性

- **目录扫描**: 支持配置多个扫描目录
- **文件过滤**: 支持文件匹配模式和排除模式
- **服务识别**: 自动识别 gRPC 服务实现
- **代码生成**: 生成自动注册代码
- **配置驱动**: 通过配置文件控制功能开关

## 配置说明

在 `application.yml` 中添加以下配置：

```yaml
auto_register:
  enabled: true                     # 是否启用自动注册
  scan_dirs:                       # 扫描目录列表
    - "./pkg/services"
    - "./internal/services"
  patterns:                        # 文件匹配模式
    - "*.go"
  excludes:                        # 排除模式
    - "*_test.go"
    - "*_mock.go"
  service_name: ""                 # 服务名称模式（可选）
```

### 配置参数说明

- `enabled`: 是否启用自动注册功能
- `scan_dirs`: 需要扫描的目录列表，支持相对路径和绝对路径
- `patterns`: 文件匹配模式，支持通配符
- `excludes`: 排除的文件模式，支持通配符
- `service_name`: 服务名称提取模式（可选）

## 服务识别规则

自动注册功能通过以下规则识别 gRPC 服务：

1. **注释标记**: 在结构体上添加 `@grpc-service` 注释
2. **RegisterService 方法**: 实现了 `RegisterService(grpc.ServiceRegistrar)` 方法
3. **命名约定**: 结构体名称以 "Service" 结尾

### 示例服务实现

```go
package services

import (
    "context"
    "github.com/go-grpc-kit/go-grpc-kit/examples/simple/proto"
    "google.golang.org/grpc"
)

// UserService 用户服务
// @grpc-service UserService
type UserService struct {
    proto.UnimplementedGreeterServer
}

// SayHello 实现 Greeter 服务的 SayHello 方法
func (s *UserService) SayHello(ctx context.Context, req *proto.HelloRequest) (*proto.HelloResponse, error) {
    return &proto.HelloResponse{
        Message: "Hello from UserService: " + req.Name,
    }, nil
}

// RegisterService 注册服务到 gRPC 服务器
func (s *UserService) RegisterService(server grpc.ServiceRegistrar) {
    proto.RegisterGreeterServer(server, s)
}
```

## 使用方式

### 1. 启用自动注册

在配置文件中启用自动注册功能：

```yaml
auto_register:
  enabled: true
  scan_dirs:
    - "./services"
```

### 2. 创建服务实现

按照上述规则创建服务实现文件。

### 3. 运行应用

```go
package main

import (
    "log"
    "github.com/go-grpc-kit/go-grpc-kit/pkg/config"
    "github.com/go-grpc-kit/go-grpc-kit/pkg/starter"
)

func main() {
    // 加载配置
    cfg, err := config.Load("./config/application.yml")
    if err != nil {
        log.Fatalf("Failed to load config: %v", err)
    }

    // 创建并运行应用
    app := starter.New(
        starter.WithConfig(cfg),
    )

    if err := app.Run(); err != nil {
        log.Fatalf("Failed to run application: %v", err)
    }
}
```

## 工作原理

1. **扫描阶段**: 扫描配置的目录，查找匹配的 Go 文件
2. **解析阶段**: 使用 Go AST 解析文件，识别服务实现
3. **生成阶段**: 生成自动注册代码文件
4. **注册阶段**: 在应用启动时执行自动注册

## 生成的代码示例

自动注册功能会生成类似以下的代码：

```go
// Code generated by go-grpc-kit autoregister. DO NOT EDIT.

package main

import (
    "github.com/example/project/services"
    "google.golang.org/grpc"
)

// AutoRegisterServices 自动注册所有服务
func AutoRegisterServices(server grpc.ServiceRegistrar) {
    // Register UserService
    services.RegisterUserServiceServer(server, &services.UserService{})
}

// GetAutoRegisteredServices 获取自动注册的服务列表
func GetAutoRegisteredServices() []string {
    return []string{
        "UserService",
    }
}
```

## 最佳实践

1. **目录结构**: 建议将服务实现放在专门的目录中，如 `pkg/services` 或 `internal/services`
2. **命名约定**: 使用一致的命名约定，如 `XxxService`
3. **注释标记**: 为服务添加 `@grpc-service` 注释以明确标识
4. **接口实现**: 确保服务实现了必要的 gRPC 接口和 `RegisterService` 方法

## 注意事项

1. 自动注册功能目前生成代码而不是运行时注册
2. 需要重新编译应用程序以使更改生效
3. 生成的代码文件不应手动编辑
4. 确保扫描目录中的文件可以正常编译

## 可行性评估

### 技术可行性: ⭐⭐⭐⭐⭐

- **Go AST 解析**: Go 提供了完善的 AST 解析能力
- **代码生成**: 可以使用模板生成注册代码
- **配置集成**: 已有完善的配置系统支持

### 实现复杂度: ⭐⭐⭐

- **中等复杂度**: 需要实现文件扫描、AST 解析、代码生成等功能
- **可维护性**: 代码结构清晰，易于维护和扩展

### 必要性评估: ⭐⭐⭐⭐

- **开发效率**: 显著减少手动注册代码
- **维护成本**: 降低服务注册的维护成本
- **用户体验**: 提供更好的开发体验

## 总结

gRPC 服务自动注册功能具有很高的可行性和实用性，能够显著提升开发效率和用户体验。建议实现该功能以增强框架的易用性。